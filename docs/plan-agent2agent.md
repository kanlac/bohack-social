# Agent 对 Agent 聊天功能 - 分阶段实施计划

## 📋 功能概述

点击「发起聊天」→ 两个数字分身（你的 AI + 对方的 AI）基于各自的 profile 进行一场有趣的对话

## 🎯 核心决策

- **对话实现方式**: 方案 B（轮流调用 AI）
- **对话长度**: 10-15 轮
- **实施方式**: 分阶段实施，每个阶段需要确认后才进入下一阶段
- **每个阶段**: 必须有可验证的成果

---

## 📍 阶段 1：UI 组件 + Mock 数据验证

### 目标
先把 UI 和交互做出来，使用假数据验证视觉效果和交互流程

### 具体任务

1. **创建 `AgentChatModal` 组件**
   - 全屏 Modal（点击探索页面的「发起聊天」打开）
   - 顶部：两个用户的头像和称号（左右对称布局）
   - 中间：对话区域（滚动容器）
   - 底部：控制按钮（关闭、重新生成）

2. **实现对话气泡展示**
   - 左边气泡：当前用户（你）
   - 右边气泡：选中的用户
   - 每条消息显示：emoji + 称号 + 内容
   - 气泡颜色区分

3. **Mock 对话数据**
   - 创建一个假的对话数组（10-15 条消息）
   - 模拟真实的对话内容
   - 测试 UI 布局和样式

4. **添加基础动画**
   - 打开/关闭 Modal 的过渡动画
   - 消息逐条出现的动画（每条间隔 1 秒）

5. **连接「发起聊天」按钮**
   - 在 `explore/page.tsx` 中添加 onClick
   - 传递选中用户的数据到 Modal
   - 传递当前用户的数据（先用 Mock）

### 可验证成果
- ✅ 点击「发起聊天」打开 Modal
- ✅ 显示 10-15 条 Mock 对话消息
- ✅ 对话逐条出现，有动画效果
- ✅ UI 美观，布局合理
- ✅ 可以关闭 Modal 返回探索页面

**预计时间**: 2-3 小时
**难度**: ⭐⭐⭐☆☆

---

## 📍 阶段 2：实现单次 AI 对话生成（测试 Agent Prompt）

### 目标
实现一个用户的数字分身，验证 Prompt 工程是否有效

### 具体任务

1. **创建 `/api/generate-agent-message` 路由**
   - 接收用户 profile 数据
   - 接收对话历史
   - 返回这个用户的 AI 分身生成的下一条消息

2. **实现 Agent Prompt 生成函数**
   ```typescript
   function generateAgentPrompt(user: User, conversationHistory: Message[]) {
     // 基于用户的 title, bio, interests, moods, project
     // 生成个性化的 system prompt
     // 让 AI 扮演这个数字分身
   }
   ```

3. **测试 Prompt 效果**
   - 在 Modal 中添加一个「测试」按钮
   - 点击后调用 API，生成一条消息
   - 验证 AI 是否能正确扮演这个用户的角色
   - 调整 Prompt 直到效果满意

4. **优化 Prompt**
   - 确保 AI 的语气符合用户的 moods
   - 确保对话内容与 interests 和 project 相关
   - 避免过长或过短的消息

### 可验证成果
- ✅ API 能成功生成一条符合用户性格的消息
- ✅ 消息内容自然、有趣
- ✅ 消息长度合适（2-3 句话）
- ✅ 在 UI 中能看到生成的消息

**预计时间**: 2-3 小时
**难度**: ⭐⭐⭐⭐☆

---

## 📍 阶段 3：实现完整的轮流对话逻辑

### 目标
两个 AI 分身轮流对话，生成完整的 10-15 轮对话

### 具体任务

1. **创建 `/api/agent-conversation` 路由**
   - 接收两个用户的 profile
   - 实现轮流调用逻辑：
     ```
     轮1: User1 说话
     轮2: User2 回应
     轮3: User1 再说
     ...
     轮10-15: 自然结束
     ```
   - 支持流式返回（可选，或者先批量返回）

2. **对话流程控制**
   - 第1条：User1 主动打招呼
   - 第2条：User2 回应 + 提问
   - 中间轮：围绕共同兴趣讨论
   - 最后1-2轮：自然收尾

3. **对话历史管理**
   - 每次调用 AI 时传入完整的对话历史
   - 确保上下文连贯

4. **在 UI 中实现**
   - 点击「开始对话」按钮
   - 显示加载状态
   - 对话逐条出现（每条间隔 2 秒）
   - 支持中途停止

### 可验证成果
- ✅ 点击「开始对话」自动生成 10-15 轮完整对话
- ✅ 对话内容连贯、自然
- ✅ 两个 AI 能围绕共同话题讨论
- ✅ 对话有开始、发展、结束的节奏
- ✅ UI 流畅展示对话过程

**预计时间**: 3-4 小时
**难度**: ⭐⭐⭐⭐⭐

---

## 📍 阶段 4：体验优化和打字机效果

### 目标
让对话展示更生动、更有趣

### 具体任务

1. **打字机效果**
   - 每条消息逐字显示
   - 调整显示速度（建议 30-50ms/字）
   - 显示"正在输入..."指示器

2. **更好的动画**
   - 气泡弹出动画（scale + fade in）
   - 滚动到最新消息
   - emoji 动画效果

3. **加载状态优化**
   - 显示两个用户头像在"思考中"
   - 波纹动画
   - 加载进度提示

4. **错误处理**
   - API 调用失败时的提示
   - 重试机制
   - 优雅降级

### 可验证成果
- ✅ 消息逐字打出，有真实感
- ✅ 动画流畅自然
- ✅ 有"正在输入..."的提示
- ✅ 错误情况有友好提示

**预计时间**: 2-3 小时
**难度**: ⭐⭐⭐☆☆

---

## 📍 阶段 5：对话摘要和匹配度分析

### 目标
对话结束后，AI 生成有趣的摘要和协作建议

### 具体任务

1. **创建 `/api/analyze-conversation` 路由**
   - 接收完整对话记录
   - 分析两个用户的协作潜力
   - 生成对话摘要

2. **摘要内容包括**
   - 一句话总结（例如："你们在 AI 项目上一拍即合！"）
   - 匹配度评分（1-100）
   - 共同兴趣点
   - 技能互补分析
   - 协作建议（2-3 条具体建议）

3. **在 UI 中展示**
   - 对话结束后显示摘要卡片
   - 动画效果
   - 可以分享摘要

### 可验证成果
- ✅ 对话结束后自动显示摘要
- ✅ 摘要内容准确、有趣
- ✅ 匹配度评分合理
- ✅ 协作建议实用

**预计时间**: 2 小时
**难度**: ⭐⭐⭐☆☆

---

## 📍 阶段 6：额外功能（可选）

### 目标
锦上添花的功能

### 具体任务

1. **重新生成对话**
   - 点击按钮重新开始一场不同的对话
   - 保留历史记录

2. **对话主题选择**
   - 开始前选择对话主题
   - 技术讨论 / 项目合作 / 轻松闲聊

3. **保存对话记录**
   - 将对话保存到数据库
   - 在用户页面查看历史对话

### 可验证成果
- ✅ 可以重新生成不同的对话
- ✅ 可以选择对话风格
- ✅ 对话记录可以保存和查看

**预计时间**: 3-4 小时
**难度**: ⭐⭐⭐⭐☆

---

## 📊 实施流程

### 每个阶段的流程
1. **开始实施** → 完成后展示成果
2. **验证和测试** → 提出修改意见
3. **修改优化** → 再次验证
4. **确认通过** → 进入下一阶段

### 预计总时间
- 阶段 1-3（核心功能）：7-10 小时
- 阶段 4-5（体验优化）：+4-5 小时
- 阶段 6（可选）：+3-4 小时

---

## 🎯 当前状态

**当前阶段**: 准备开始阶段 1
**最后更新**: 2025-12-28

---

## 📝 开发日志

### 2025-12-28
- 完成计划文档
- 等待确认开始阶段 1

---

## 技术栈

- **AI**: Qwen API (通过 OpenAI 兼容模式)
- **UI**: Framer Motion
- **对话生成**: AI SDK v6 - `generateText`
- **状态管理**: React useState + useEffect

---

## 数据结构

### AgentChatMessage
```typescript
interface AgentChatMessage {
  role: 'user1' | 'user2'  // 哪个数字分身在说话
  userName: string         // 用户称号
  emoji: string           // emoji 头像
  content: string         // 对话内容
  timestamp: number
}
```

### User Profile（已有）
```typescript
interface User {
  id: string
  emoji: string
  title: string          // AI 生成的称号
  project: string
  bio: string           // AI 生成的个性签名
  interests: string[]
  moods: string[]
  wechat?: string
  answers?: Answer[]
}
```
